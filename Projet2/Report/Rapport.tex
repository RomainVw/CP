\documentclass[a4paper ,12pt,french]{article}
% Packages usuels
%\usepackage{etex} % pour circuitikz
%\usepackage{tikz}
%\usepackage{circuitikz} % pour les circuits électriques

\usepackage[utf8]{inputenc}
%\usepackage[margin=1.55cm]{geometry}
\usepackage[bottom=2cm , left=2.5cm ,right=2.5cm, top=2cm]{geometry}
\usepackage[T1]{fontenc}
\usepackage{url}
%\usepackage{color}
\usepackage{lmodern}
\usepackage[french]{babel}
\usepackage[indentfirst]{titlesec}
\usepackage[dvips]{graphicx}
\usepackage{eurosym}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{makeidx}
\usepackage{array}
\usepackage{colortbl}
\usepackage[table,dvipsnames,svgnames]{xcolor}
\usepackage{xspace}
\usepackage{fancybox}
\usepackage{textcomp}
\usepackage{listings}


\usepackage{hyperref}
\usepackage{setspace}
\usepackage{fancyhdr}
\usepackage{graphicx}

%\usepackage[margin=0.75in]{geometry}
\usepackage[version=3]{mhchem}
%\usepackage{chemist}
\usepackage{multicol}
\usepackage{float}
\usepackage{wrapfig} %écrire txt et image côte à côte
\usepackage[rightcaption]{sidecap}
\usepackage{amsthm}
\usepackage[squaren, Gray, cdot]{SIunits}
\usepackage[absolute]{textpos}%positionnement de cadres
\usepackage[final]{pdfpages} %traitement des pdf
\usepackage{subfigure}
%\usepackage[framed,numbered,autolinebreaks,useliterate]{mcode}%pour traiter le code matlab
%\usepackage{setspace}% pour les interlignes
%\onehalfspacing %interligne 1.5
%\doublespacing %interligne 2
%\renewcommand{\baselinestretch}{1.5}  %interligne défini
%\usepackage{vmargin}% pour les marges
%\setmarginsrb{2.5}{2.5}{2.5}{2.5}{}{}{}{} % marges de 2.5 cm 
%\addto\captionsfrench{\def\tablename{Tableau}} % pour avoir TABLEAU et pas TABLE dans la légende des tableaux..
%\setlength{\parskip}{1cm}   %espacement fixe entre chaque paragraphe
\setlength{\parindent}{1cm}  %modifie la valeur de l'alinéas
%\addtolength{\voffset}{-1.5cm} % (diminue la marge du haut)
\addtolength{\textheight}{-2cm} % (augmente la longueur du texte)
%\addtolength{\hoffset}{-1cm} (diminue la marge de gauche)
%\addtolength{\textwidth}{2cm}  (augmente la largeur du texte)
%\addtocounter{secnumdepth}{1}  si jamais on veut utiliser \subsubsubsecion
\usepackage[hang,center,bf]{caption} %pour les légendes
\setlength{\captionmargin}{30pt}
\usepackage[hang,flushmargin]{footmisc} %à mettre avec ENGLISH dans babel pour avoir les notes de bas de page à gauche et non indentées
\usepackage[nonumberlist,style=altlist,toc]{glossaries} % Pour faire un glossaire
\makeglossaries
%\addto\captionsfrench{\renewcommand*{\glossaryname}{Glossary}}
\usepackage{wasysym}
\usepackage[square, numbers, comma, sort&compress]{natbib} % Use the natbib reference package - read up on this to edit the reference style; if you want text (e.g. Smith et al., 2012) for the in-text references (instead of numbers), remove 'numbers' 
%\hypersetup{urlcolor=blue, colorlinks=true} % Colors hyperlinks in blue - change to black if annoying
\title{Project 2 - Constraint Programming } % Defines the thesis title - don't touch this
%-------------------------------------------------------------------------------------------------------------------------------------------------------------




\begin{document}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}

\lstset{ %
  language=c,                				% the language of the code
  basicstyle=\footnotesize,           	% the size of the fonts that are used for the code
  numbers=left,                   			% where to put the line-numbers
  numberstyle=\tiny\color{gray},  	% the style that is used for the line-numbers
  stepnumber=1,                   			% the step between two line-numbers. If it's 1, each line 
                                  						% will be numbered
  numbersep=5pt,                  			% how far the line-numbers are from the code
  backgroundcolor=\color{white},   % choose the background color. You must add \usepackage{color}
  showspaces=false,               % show spaces adding particular underscores
  showstringspaces=false,         % underline spaces within strings
  showtabs=false,                 % show tabs within strings adding particular underscores
  frame=single,                   % adds a frame around the code
  rulecolor=\color{black},        % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. commens (green here))
  tabsize=4,                      % sets default tabsize to 2 spaces
  captionpos=b,                   % sets the caption-position to bottom
  breaklines=true,                % sets automatic line breaking
  breakatwhitespace=false,        % sets if automatic breaks should only happen at whitespace
  title=\lstname,                   % show the filename of files included with \lstinputlisting;
                                  % also try caption instead of title
  keywordstyle=\color{blue},          % keyword style
  commentstyle=\color{dkgreen},       % comment style
  stringstyle=\color{mauve},         % string literal style
  escapeinside={\%*}{*)},            % if you want to add LaTeX within your code
  morekeywords={*,...}               % if you want to add more keywords to the set
}

\floatstyle{plain}
%\newfloat{graphique}{!hb}{lgr}[chapter]
\floatname{graphique}{Graph}

%\setstretch{1.1} % Line spacing of 1.3

% Define the page headers using the FancyHdr package and set up for one-sided printing
\fancyhead{} % Clears all page headers and footers
\rhead{\thepage} % Sets the right side header to show the page number
\lhead{} % Clears the left side page header

\pagestyle{fancy} % Finally, use the "fancy" page style to implement the FancyHdr headers

\newcommand{\HRule}{\rule{\linewidth}{0.5mm}} % New command to make the lines in the title page

\begin{titlepage}
\pagestyle{fancy} % Finally, use the "fancy" page style to implement the FancyHdr headers

\begin{tabular}{cc}
\begin{minipage}{0.5\textwidth}
\begin{flushleft}
\includegraphics[scale=0.1]{./logoingisbleu.jpg} % University/department logo - uncomment to place it
\end{flushleft}
\end{minipage}
 & 
 \begin{minipage}{0.43\textwidth}
\begin{flushright}
\includegraphics[scale=0.5]{./epl.jpg} % University/department logo - uncomment to place it
\end{flushright}
\end{minipage}
\end{tabular} 



\begin{center}
\vspace{100 px}
\textsc{\LARGE Catholic University of Louvain}\\[1cm] % University name
\textsc{\Large Project 2 : Propagation}\\[0.5cm] % Thesis type
 
\HRule \\[0.4cm] % Horizontal line
{\huge \bfseries LINGI2365 - Constraint Programming}\\[0.4cm] % Thesis title
\HRule \\[1.5cm] % Horizontal line
 

\begin{tabular}{cc}
\begin{minipage}{0.5\textwidth}
\begin{flushleft} \large
\emph{Auteurs:}\\
{Vanwelde Romain (3143-10-00)\\
Crochelet Martin (2236-10-00)\\ \ \\
Groupe 7} 
\end{flushleft}
\end{minipage} & \begin{minipage}{0.46\textwidth}
\centering
\begin{flushright} \large
\emph{Superviseurs:} \\
{Pr. Yves Deville\\
François Aubry
}
\end{flushright}
\end{minipage}\\[3cm] \\ 
\end{tabular} 

 
%\large \textit{A thesis submitted in fulfilment of the requirements\\ for the degree of \degreename}\\[0.3cm] % University requirement text
%\textit{in the}\\[0.4cm]
%\groupname\\\deptname\\[2cm] % Research group name and department name

 \begin{center}
{\large \today }\\[4cm] % Date 
 \end{center}


\vfill
\end{center}

\end{titlepage}

\lhead{\emph{Table of Contents}} % Set the left side page header to "Contents"
\tableofcontents % Write out the Table of Contents

\thispagestyle{fancy}

\pagebreak
\setcounter{page}{1}
\pagestyle{fancy} % Finally, use the "fancy" page style to implement the FancyHdr headers

\section{Questions}
\subsection{Explain in detail the time and space complexities of the DC3 algorithm. What is the time complexity if all the constraints are domain consistent when algorithm DC3 is called?}
With the notations: \begin{itemize}
\item $e = \#C$ where $C$ is the set of constraints that set up the problem and $e$, the number of constraints.
\item $d = \max_{1\leq i \leq n}(\#D(x))$ where $D(x)$ is the domain of the variable $x$ and thus $d$, the maximum size of the domains. 
\item $r$ that is defined as the maximum arity of a constraint for the CSP.
\end{itemize}
And the supposition that each variable is involved in at least one constraint (and that the constraints might have an arity superior to two - otherwise we would reduce to AC3).\\

Analysing the algorithm shows us that DC3 keeps a queue that contains the set of constraints for whom the domain consistency is no longer guaranteed. In the worst case, we can easily imagine that every constraint of the problem will find it's place in that queue. Knowing that the number of constraints for a CSP is defined as $e$, we can deduce that the worst-case space complexity involved with the DC3 algorithm is $O(e)$ (Note that this is independent of for data-structures used by the propagate method)\\

Concerning the time complexity, we will split our analysis into two different parts: first, we will analyse the time-complexity of the standard CDC algorithm since the DC3 one in a basic instance of CDC. Lastly, we will tackle the analysis of the DC3-specific propagate method.

For a non binary CSP, we begin by observing that a constraint can be put at most $r\cdot d$ times in the queue (maximum arity of a constraint time the maximum size of a domain) and that at most, since we iterate over that queue to call propagate, the propagate method will be executed $e\cdot r\cdot d$ times (the number of constraints times the maximum number of times a constraint can be put into the queue). 

Furthermore, we can remark that the DC3-specific propagate method iterates over each variables of a constraint and over the domain of that constraint $O(r\cdot d)$ This iteration executes a code verifies for each value if it is still consistent with the constraint and construct the delta set. This implies that the algorithm has to iterates over all other variables of the constraint to check if a possible assignment exists for the current choice of assignment: the execute runs in $O(r\cdot d^{r-1})$ and is executed at most $r$ times. The time-complexity of the DC3-specific propagate method is thus $O(r^2 \cdot d^{r})$.

We can then deduce that the overall complexity of DC3 is the product of the two complexities and equals $O(e\cdot r\cdot d\cdot r^2\cdot d^{r}) = O(e\cdot r^3 \cdot d^{r+1})$
\subsection{In the algorithm CDC (5.1 in the book), what would be the effect of moving the instruction of line 21 (Q -= c) after line 16? Would the algorithm still be correct?}
The algorithm would not be correct since it would never terminate. Indeed, moving the line just after line 16 would remove the constraint from the queue and then re add it into the queue since the enqueueCDC would contain the constraint itself. The algorithm would iterate forever over the constraints and never leave the loop. 
\subsection{Consider the constraint X - a = Y .}
\subsubsection{Show that it is domain consistent if and only if D(X) - a = D(Y ).}
This directly derives from the definition of domain consistent : suppose that a value that belongs to X generates a value $X' = X - a$ that does not belong to the domain of Y then the domain would not be consistent since the definition of domain consistent is that for all values that belong to the domain of the variable, there exists at least one value in the domains of the other variables of the constraint that satisfies the constraint. 
\subsubsection{What is the definition of bound consistency for this constraint?}
The bound consistency is a weaker form of domain consistency in the sense that it only considers the bounds of the domain. This means that we actually have two conditions: one on the minima of the variables and one on the maxima: \begin{itemize}
\item on the minima: $\min_{x\in D(X)}(x) - a = \min_{y\in D(Y)}(y)$
\item on the maxima: $\max_{x\in D(X)}(x) - a = \max_{y\in D(Y)}(y)$
\end{itemize}
\subsubsection{Is this constraint automatically bound consistent if it is domain consistent?}
Indeed, if the constraint is domain consistent, this means that the bound are also consistent since they belong to the domain and that all the values in the domain satisfies the constraint. Bound consistency is a weaker form of domain consistency. 

\subsubsection{Is this constraint automatically domain consistent if it is bound consistent?}
No the implication if false in this sense. Indeed for a constraint such as $x^2 = y$, and the domains $[0, 1, 2, 3, 4, 5, 6, 7, 8]$ for both variables, bound consistency would return the domains: $\{x := [0, 1, 2], y := [0, 1, 2, 3, 4] \}$ while domain consistency would give the domains: $\{x := [0, 1, 2], y := [0, 1, 4] \}$.
\section{Problems}
\subsection{AC3 propagator}
\subsubsection{What is the definition of domain consistency for this constraint}
Intuitively, the domain consistency is the set of values of the domain that have a support (meaning a value that satisfies the constraint) in the domain of the other variables of the constraint. In this case, the domain consistency and bound consistency are equivalent under the assumption that the domain for $X$ and $Y$ are ordonable values. Indeed, since the constraint is linear, the condition on the bounds of the domains is sufficient to provoke a domain consistency. We have then the conditions: 
\begin{itemize}
\item $\min_{x\in D(X)}(x) \geq \min_{y\in D(Y)}(y) + a$
\item $\max_{x\in D(X)}(x) \geq \max_{y\in D(Y)}(y) + a$
\end{itemize}
Note that the $\geq$ plays an important role as well : in the previous case of constraint (same constraint but with equality), the domain consistency was different from the bound consistency. Indeed, the equality forces the values in the domain of Y to follow a linear function of the values of X while in the case of the $\geq$, the values of Y "just" have to belong to a subset of the plane that is defined by the minima and maxima of the domain of X.
\subsubsection{Are domain consistency and bound consistency equivalent for this constraint? Prove why they are, or why they are not.}
See previous question.
\subsubsection{What do the lines \_x.addMax(this) and \_y.addMin(this) in post do?}
Since we are using bound consistency (equivalent to domain consistency in this case), we can implement the CDC algorithm by using two different queues of propagation: one for the maxima and one for the minima). This is a simple optimization that allows to reconsider only the constraints that have been "touched" by the modification of the maxima \textit{or} minima of a domain. The two lines in questions defines those queues and initialises them by putting all the constraints of the CSP into the queues. This corresponds to the initCDC method of the algorithm 5.1 of the book.
\subsubsection{Explain why the propagate method is correct.}
This implementation begins by updating the min and max of the domains of the variables and, if one of the domain boils down to zero, the propagation returns a failure. Otherwise, the propagation will test if the current assignment satisfies the constraint and, if it's the case, it returns a success. 
In the last case, the implementation will return a suspend meaning that the current assignment does not satisfies the constraint but that there are still values in the domain that have to be tried. 

Furthermore, the propagate method has important side effects: it reduces the domain of the variables in order to accelerate the search by removing bounds of the domains. The specifications demand the new domain to be a subset of the previous one and that it still contains all the possible solutions for the CSP. This is easy to see considering the fact that the propagate method only removes values (via update$Max\vert Min$) that are proved to not satisfy the constraint.


\subsection{The channeling constraint}
\subsubsection{Give the definition of domain consistency for this constraint}
The definition of domain consistency for this constraint is the following one :
\begin{center}
$\forall x$ $\epsilon X$, $\exists y$ $\epsilon Y$ • x[i] = (y==i) \& $\forall y$ $\epsilon Y$, $\exists x$ $\epsilon X$ • x[i] = (y==i)\\
\end{center} 



\subsubsection{Implement an AC5 propagator achieving domain consistency for this constraint.}
We had to implement method \texttt{valRemove} and \texttt{valBind}.

A important fact to notice for the next of the exercise is that the array can only contain one true value since the Y variable is an integer.\\

For the valRemove method, we first determine if the value removed is from Y domain or from one of the $X_i$ domains.\\
If the value has been removed  from the Y domain, we can directly determine that $\_X[value] == 0$. (Thanks to the constraint).\\
If we remove the value from one of the $X_i$ domains, we can deduce more informations depending on the value. \textbf{If value equals 0}, we know that the only remaining value to that domain is 1. Then, we can thus deduce the only remaining value we can attribute to the variable Y which is the index of the $X_i$ variable binded. We can furthermore bind all others $X_i$ varaibles to 0.  \textbf{If value equals 1}, we know that the only remaining value to that domain is 0, and we can remove the index of the $X_i$ variable binded from the Y domain.

\lstinputlisting[language=C]{ValRemove_Channeling.co}

The valRemove method do similar things.\\
First, if the binded variable is Y, we can deduce the entire corresponding array.\\
If the binded varaible is on of the $X_i$ variables, we can determine some informations depending of the value binded.\\
\textbf{If the value is 1}, we can determine that all the others $X_i$ variables equals 0 and that the Y variable equals the index of the binded $X_i$ variable. \\ \textbf{If the value is 0}, we can just remove the corresponding index of the domain of Y.
\lstinputlisting[language=C]{ValBind_Channeling.co}

\subsection{AC2001 propagator}


\subsubsection{Generic constraint}
We first declare the two constraints variables and the two support structures.
\lstinputlisting[language=C]{AC2001Constraint_variables.co}

In the constructor, we assign constraints variables, and we instantiate the support structure.
\lstinputlisting[language=C]{AC2001Constraint_constructor.co}

Then, in the post method, we initialize support structures, we do the initial propagation, and we suscribe to some events.
\lstinputlisting[language=C]{AC2001Constraint_post.co}

The propagate method is the most important one. It propagates for X and Y. We iterate on all variables, and beginning at the firstSupportValue, we try to find the new one (which could remain the same). Once there are no more firstSupportValue, we remove the value of the corresponding domain.
\lstinputlisting[language=C]{AC2001Constraint_propagate.co}

\subsubsection{Specific constraints}
Here is the method check for the first three constraints.
\lstinputlisting[language=C]{AllConstraints.co}

\subsection{The AllDifferent constraint}
\subsubsection{Define forward-checking consistency for the decomposition of AllDiff in binary constraints.}

A constraint c($x_m$,$x_n$) is FC consistent wrt D(X) iff:
\begin{itemize}
\item if $\forall x_i$ $\epsilon$ $\{x_m,x_n\}$ : $D(x_i) = \{a_i\}$, then c($a_m$,$a_n$) 
\item if $\exists y$ $\epsilon$ $\{x_m,x_n\}$ $\forall x$ $\epsilon$ $\{x_m,x_n\}\backslash\{y\}$ : \#D(x) = 1, then c is domain consistent wrt D(X)\\
\end{itemize}

Here, AllDiff is FC consistent if
\begin{center}
$\forall i$ $\epsilon$ $\{1,k\}$, $\forall j$ $\epsilon$ $\{1,k\}$, $i!=j$ • c($x_m$,$x_n$) is FC consistent.
\end{center}

\subsubsection{Implement a propagator ensuring a consistency for AllDiff equivalent to forward- checking consistency for the decomposition of AllDiff (\dots)}
In the post method, we iterate on all the variables. Those who are not bind are subscribed to bind event.
\lstinputlisting[language=C]{AllDiffFC_post.co}

In the valBind method, we remove from all variable's domain different from the one which have been binded, the value that have been binded.
\lstinputlisting[language=C]{AllDiffFC_valBind.co}
\subsubsection{Modify the Nqueens.co file provided into file NqueensFC.co such that it uses your implementation of alldifferent.}
The only lines which have been modified are the lines who post the constraints. The constructor used creates a "fake" variable known as a view.
\lstinputlisting[language=C]{NQueensFC.co}
\subsubsection{Test both yours (NqueensFC.co) and Comet’s (Nqueens.co) implementation of AllDifferent on the NQueens problem. Compare the number of failures and choices between the two implementations and for each n = 12 . . . 32 in a table.}

\begin{figure}[!h]\hspace{-1cm}
\begin{tabular}{|c||r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|}
\hline
n&12&13&14&15&16&17&18&19&20&21&22 &23&24  \\
\hline\hline
NQueens &20&11&117&79&597&327&1.936&71&7.341&160&57.834 &339 &8.203   \\
\hline
NQueensFC &34&32&208&143&1.123&752&4.508&381&22.220&943& 162.268 &2.510 &38.902\\
\hline
\end{tabular}
\begin{tabular}{|c||r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|}
\hline
n&25&26&27&28&29&30&31&32   \\
\hline\hline
NQueens &455&5.138&4.649&36.342&13.672&758.650&112.867&826.632     \\
\hline
NQueensFC &4.507&34.458&39.943&252.503&126.158&4.574.951&1.087.399&7.040.698  \\
\hline
\end{tabular}
\caption{Choices}
\end{figure}
\begin{figure}[!h]\hspace{-1.2cm}
\begin{tabular}{|c||r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|}
\hline
n&12&13&14&15&16&17&18&19&20&21&22 &23&24  \\
\hline\hline
NQueens &39&13&270&176&1.358&714&4.540&172&17.921&399&135.923&847&19.603    \\
\hline
NQueensFC &64&16&423&290&2.305&1.561&9.557&742&48.059&1.959&343.151& 5.193 &81.171    \\
\hline
\end{tabular}
\\
\begin{tabular}{|c||r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|r|}
\hline
n&25&26&27&28&29&30&31&32   \\
\hline\hline
NQueens &1.150&12.032&12.211&89.509&35.369&1.837.227&288.305&2.057.346    \\
\hline
NQueensFC &9.149&69.903& 84.175&523.005&266.235& 9.374.708&2.250.869&14.336.324 \\
\hline
\end{tabular}
\caption{Failures}
\end{figure}



\newpage
\subsubsection{What did you find in your comparative study? Explain the results!}

First, we observe that our implementation of allDifferent has each time a number of choices bigger than in the comet's implementation. Since this number is bigger, we will have to try more values before finding a good one. Thus, we will have more failures.


\end{document}