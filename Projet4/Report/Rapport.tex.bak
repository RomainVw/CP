\documentclass[a4paper ,12pt,french]{article}
% Packages usuels
%\usepackage{etex} % pour circuitikz
%\usepackage{tikz}
%\usepackage{circuitikz} % pour les circuits électriques

\usepackage[utf8]{inputenc}
%\usepackage[margin=1.55cm]{geometry}
\usepackage[bottom=2cm , left=2.5cm ,right=2.5cm, top=2cm]{geometry}
\usepackage[T1]{fontenc}
\usepackage{url}
%\usepackage{color}
\usepackage{lmodern}
\usepackage[french]{babel}
\usepackage[indentfirst]{titlesec}
\usepackage[dvips]{graphicx}
\usepackage{eurosym}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{makeidx}
\usepackage{array}
\usepackage{colortbl}
\usepackage[table,dvipsnames,svgnames]{xcolor}
\usepackage{xspace}
\usepackage{fancybox}
\usepackage{textcomp}
\usepackage{listings}


\usepackage{hyperref}
\usepackage{setspace}
\usepackage{fancyhdr}
\usepackage{graphicx}

%\usepackage[margin=0.75in]{geometry}
\usepackage[version=3]{mhchem}
%\usepackage{chemist}
\usepackage{multicol}
\usepackage{float}
\usepackage{wrapfig} %écrire txt et image côte à côte
\usepackage[rightcaption]{sidecap}
\usepackage{amsthm}
\usepackage[squaren, Gray, cdot]{SIunits}
\usepackage[absolute]{textpos}%positionnement de cadres
\usepackage[final]{pdfpages} %traitement des pdf
\usepackage{subfigure}
%\usepackage[framed,numbered,autolinebreaks,useliterate]{mcode}%pour traiter le code matlab
%\usepackage{setspace}% pour les interlignes
%\onehalfspacing %interligne 1.5
%\doublespacing %interligne 2
%\renewcommand{\baselinestretch}{1.5}  %interligne défini
%\usepackage{vmargin}% pour les marges
%\setmarginsrb{2.5}{2.5}{2.5}{2.5}{}{}{}{} % marges de 2.5 cm 
%\addto\captionsfrench{\def\tablename{Tableau}} % pour avoir TABLEAU et pas TABLE dans la légende des tableaux..
%\setlength{\parskip}{1cm}   %espacement fixe entre chaque paragraphe
\setlength{\parindent}{1cm}  %modifie la valeur de l'alinéas
%\addtolength{\voffset}{-1.5cm} % (diminue la marge du haut)
\addtolength{\textheight}{-2cm} % (augmente la longueur du texte)
%\addtolength{\hoffset}{-1cm} (diminue la marge de gauche)
%\addtolength{\textwidth}{2cm}  (augmente la largeur du texte)
%\addtocounter{secnumdepth}{1}  si jamais on veut utiliser \subsubsubsecion
\usepackage[hang,center,bf]{caption} %pour les légendes
\setlength{\captionmargin}{30pt}
\usepackage[hang,flushmargin]{footmisc} %à mettre avec ENGLISH dans babel pour avoir les notes de bas de page à gauche et non indentées
\usepackage[nonumberlist,style=altlist,toc]{glossaries} % Pour faire un glossaire
\makeglossaries
%\addto\captionsfrench{\renewcommand*{\glossaryname}{Glossary}}
\usepackage{wasysym}
\usepackage[square, numbers, comma, sort&compress]{natbib} % Use the natbib reference package - read up on this to edit the reference style; if you want text (e.g. Smith et al., 2012) for the in-text references (instead of numbers), remove 'numbers' 
%\hypersetup{urlcolor=blue, colorlinks=true} % Colors hyperlinks in blue - change to black if annoying
\title{Project 2 - Constraint Programming } % Defines the thesis title - don't touch this
%-------------------------------------------------------------------------------------------------------------------------------------------------------------




\begin{document}

\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}

\lstset{ %
  language=c,                				% the language of the code
  basicstyle=\footnotesize,           	% the size of the fonts that are used for the code
  numbers=left,                   			% where to put the line-numbers
  numberstyle=\tiny\color{gray},  	% the style that is used for the line-numbers
  stepnumber=1,                   			% the step between two line-numbers. If it's 1, each line 
                                  						% will be numbered
  numbersep=5pt,                  			% how far the line-numbers are from the code
  backgroundcolor=\color{white},   % choose the background color. You must add \usepackage{color}
  showspaces=false,               % show spaces adding particular underscores
  showstringspaces=false,         % underline spaces within strings
  showtabs=false,                 % show tabs within strings adding particular underscores
  frame=single,                   % adds a frame around the code
  rulecolor=\color{black},        % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. commens (green here))
  tabsize=4,                      % sets default tabsize to 2 spaces
  captionpos=b,                   % sets the caption-position to bottom
  breaklines=true,                % sets automatic line breaking
  breakatwhitespace=false,        % sets if automatic breaks should only happen at whitespace
  title=\lstname,                   % show the filename of files included with \lstinputlisting;
                                  % also try caption instead of title
  keywordstyle=\color{blue},          % keyword style
  commentstyle=\color{dkgreen},       % comment style
  stringstyle=\color{mauve},         % string literal style
  escapeinside={\%*}{*)},            % if you want to add LaTeX within your code
  morekeywords={*,...}               % if you want to add more keywords to the set
}

\floatstyle{plain}
%\newfloat{graphique}{!hb}{lgr}[chapter]
\floatname{graphique}{Graph}

%\setstretch{1.1} % Line spacing of 1.3

% Define the page headers using the FancyHdr package and set up for one-sided printing
\fancyhead{} % Clears all page headers and footers
\rhead{\thepage} % Sets the right side header to show the page number
\lhead{} % Clears the left side page header

\pagestyle{fancy} % Finally, use the "fancy" page style to implement the FancyHdr headers

\newcommand{\HRule}{\rule{\linewidth}{0.5mm}} % New command to make the lines in the title page

\begin{titlepage}
\pagestyle{fancy} % Finally, use the "fancy" page style to implement the FancyHdr headers

\begin{tabular}{cc}
\begin{minipage}{0.5\textwidth}
\begin{flushleft}
\includegraphics[scale=0.1]{./logoingisbleu.jpg} % University/department logo - uncomment to place it
\end{flushleft}
\end{minipage}
 & 
 \begin{minipage}{0.43\textwidth}
\begin{flushright}
\includegraphics[scale=0.5]{./epl.jpg} % University/department logo - uncomment to place it
\end{flushright}
\end{minipage}
\end{tabular} 



\begin{center}
\vspace{100 px}
\textsc{\LARGE Catholic University of Louvain}\\[1cm] % University name
\textsc{\Large Project 4 : Modeling}\\[0.5cm] % Thesis type
 
\HRule \\[0.4cm] % Horizontal line
{\huge \bfseries LINGI2365 - Constraint Programming}\\[0.4cm] % Thesis title
\HRule \\[1.5cm] % Horizontal line
 

\begin{tabular}{cc}
\begin{minipage}{0.5\textwidth}
\begin{flushleft} \large
\emph{Auteurs:}\\
{Vanwelde Romain (3143-10-00)\\
Crochelet Martin (2236-10-00)\\ \ \\
Groupe 7} 
\end{flushleft}
\end{minipage} & \begin{minipage}{0.46\textwidth}
\centering
\begin{flushright} \large
\emph{Superviseurs:} \\
{Pr. Yves Deville\\
François Aubry
}
\end{flushright}
\end{minipage}\\[3cm] \\ 
\end{tabular} 

 
%\large \textit{A thesis submitted in fulfilment of the requirements\\ for the degree of \degreename}\\[0.3cm] % University requirement text
%\textit{in the}\\[0.4cm]
%\groupname\\\deptname\\[2cm] % Research group name and department name

 \begin{center}
{\large \today }\\[4cm] % Date 
 \end{center}


\vfill
\end{center}

\end{titlepage}

\lhead{\emph{LINGI2365 - Constraint Programming}} % Set the left side page header to "Contents"
\tableofcontents % Write out the Table of Contents

\thispagestyle{fancy}

\pagebreak
\setcounter{page}{1}
\pagestyle{fancy} % Finally, use the "fancy" page style to implement the FancyHdr headers

\section{Louvain-La-Neuve Golfer Problem}
\subsection{Explain which symmetries can arise for this problem.}
This problem is highly symmetrical: indeed we can easily identify four different type of symmetry: 
\begin{itemize}
\item Two different teams can be switched for the same week
\item For two players, we can switch their planning entirely
\item Inside a group, the players can be switched anyway we want
\item Two different weeks can be switched entirely
\end{itemize}
Moreover, from the point of view of the constraints, stating that player A can't play twice with player B is strictly equivalent to saying that player B can't play twice with player A. This has a huge impact on the performances of the models.
\subsection{Describe two possible models for this problem. }
\subsubsection{explain your models in detail}
\begin{itemize}
\item The first model we consider is actually the most powerful of them both: it uses a variable that stores for each player and each week, the group in which the golfer plays. This formulation benefits from various advantages, simplicity being one of the most valuable. Indeed, we can summarize the constraints applied to the CSP into two types: \begin{itemize}
\item the first type is simply the necessity that all groups are full. This is important because it is not naturally forced by our choice of variable: indeed a simple (despite false) solution to the problem is that no golfer at all plays during the weeks.
\item the second type is a constraint that derives from the definition of the problem: no golfer can play with another more than once. We simply verify that there is not two weeks where two players belong to the same group. The finesse here is that we only set half the constraints: indeed, as explained hereabove, the other half is just redundant and would consume CPU time to be verified.
\end{itemize}

\item the second model we considered is using a 3D matrix in order to keep track of the position of the golfers. We use a variable that stores, for each week, group, slot, the golfer that takes it. This choice has proven more difficult to use to express our constraints since we add a new dimension, the slot that complexifies the search. The main idea behind this choice was that we could control the symmetry generated by the slots but this has proven itself quite difficult. Moreover, the memory space taken by this model is smaller (for a number of weeks smaller than 8) the one taken by the previous model. The constraints we use here are: \begin{itemize}
\item the fact that a player can only appear once per week in the planning (that is not enforces by our choice of variable). This means that all assignments of our variable for a same week must be different. 
\item The fact that a player can play with another at most once (again, on half of the domain).
\end{itemize}
\end{itemize}
\subsubsection{explain how you can modify your models to take symmetries into account}
We use the symmetries of the problem by breaking them and by doing that pruning the search space from the very beginning. (SBSA) Indeed, in both case, we arbitrarily choose the assignment for the first week and the assignment of the first golfer for the whole planning. By doing that, we remove already a great number of possible states: we remove the symmetrical states of the first week as well as the ones for the position of the first player. Moreover, this selective assignment does not remove any solution thanks to the symmetry of the problem.
\subsection{Implement both models (considering symmetries) in Comet.}
cf. code.
\subsection{Explain which variable / value ordering heuristics you use with each model.}
In both model, we use the simple heuristic of the least remaining values. However, the order in which we consider the dimensions is quite important:\begin{itemize}
\item for the first model, we consider first the golfers that have most of their planning complete and then the weeks that are almost already planned. By doing so it that order, we rapidly fail to assign the golfers to a group and can prune the search tree more extensively.
\item for the second model, we have not determined any particular order since any order we tried decreased the performances of a non negligible factor. 
\end{itemize}
\subsection{What is the theoretical maximum number of week in a schedule?}
The simplest way to think about that is to think by absurd:
Imagine that we could plan the golfers for 11 weeks, that would mean that one player "p" would need to play with $3\cdot 11$ different players. This is impossible because we have only 31 different players at our disposal. Leading the same reflexion for 10 weeks easily show that it is feasible. 
\subsection{Indicate the maximum number of weeks you could identify in a reasonable time limit using both models.}
With the first algorithm (as stated hereafter) we easily find the solution for 9 weeks after 372 ms and have to kill the program after 5 min of research for the 10 weeks planning. 
\subsection{Indicate for each model, for each number of weeks the time needed to find a solution, the number of failures and the number of choices. Explain the results, do they correspond to what you would have expected?}
\begin{center}

\begin{tabular}{|c|c|c|c|c|}
\hline
Algorithm & Week & Time taken (ms) & Choices & Failures\\
\hline
1 & 3 & 23 & 62 & 224\\
\hline
1 & 4 & 46 & 93 & 336\\
\hline
1 & 5 & 74 & 124 & 448\\
\hline
1 & 6 & 135 & 155 & 560\\
\hline
1 & 7 & 177 & 186 & 672\\
\hline
1 & 8 & 260 & 228 & 872\\
\hline
1 & 9 & 372 & 259 & 984\\
\hline
1 & 10 & killed after 5 min & / & /\\
\hline
2 & 3 & 1903 & 96 & 1488\\
\hline
2 & 4 & 2885 & 128 & 1984\\
\hline
2 & 5 & 4086 & 160 & 2480\\
\hline
2 & 6 & killed after 5 min & / & /\\
\hline
2 & 7 & / & / & / \\
\hline
2 & 8 & / & / & / \\
\hline
2 & 9 & / & / & / \\
\hline
2 & 10 & / & / & / \\
\hline
\hline
\end{tabular} 
\end{center}
\section{The Time Tabling Problem}
\subsection{Explain which symmetries arise in this problem.}

The first symmetry we find is in relation with timeslots. Indeed, we can easily invert all the course given at specific timeslot with all the courses of another timeslot.\\

A second symmetry could be the attribution of rooms that are exactly the same (same features, and same capacity). Since we assume that this kind of symmetry doesn't happen often, and that it's something quite tricky to express in our model, we didn't implement it in our model.

\subsection{Design an efficient model for this problem.}

\lstinputlisting[language=C]{time_tabling_model.co}



\subsection{Explain your model for this problem and explain how it handles symmetries.}

In the model, the data variables contains information extract from the inputfile. We added one data variable (\texttt{nstudentattends}) which will store the number of students which assists to different courses.

The model is composed of 3 model variables, which are \texttt{lectureslot}, \texttt{lectureroom} and \texttt{roomslotid}. \texttt{lectureslot} gives, for each event, all the possible timeslots for this event. \texttt{lectureroom} gives, for each event, all the possible rooms for this event. Finally, \texttt{roomslotid} gives an ID for each possible combination of room/timeslot.

\lstinputlisting[language=C]{time_tabling_symmetry.co}

The symmetry concerning the time is handeled in the solver, we can arbitrary fix the first timeslot to any course. Then, we continue to handle it by trying to bound \texttt{lectureslot} by growing slot ID. An event will then be assign to a slot which already contains some events, or the first which has no events yet, but it will never visit events with higher ID (if the problem is solvable).

\subsection{Implement your model in Comet.}

Here are the constraints implemented in Comet. All others important part are already in the previous sections.
\lstinputlisting[language=C]{time_tabling_constraint.co}



\subsection{To solve this problem you will need a search procedure that is more efficient than a simple label.}

We first implemented our model by binding variables which have few rooms left, then by binding variables which have few timeslots left. We decided to do it in this way (and not first the timeslots then the rooms) after some tests which were showing that the second solution were far away lower than the first one. This is probably because finding an appropriate room is more difficult in this problem than finding a good timeslot. The code is already given in previous section, and the results of the tests are in the next one.

\subsection{Test your model on each of the instances provided on the iCampus site. Indicate for each instance the time needed to solve it, the number of failures and the number of choices.}

\begin{tabular}{|c|c|c|c|}
\hline
File ID& Time & \#Failures & \#Choices\\
\hline
\hline
\#1&3685&1&800\\
\hline
\#2&3535&0&800\\
\hline
\#3&2671&368&1041\\
\hline
\#4&307397&259291&140520\\
\hline
\#5&Out Of Time&Out Of Time&Out Of Time\\
\hline
\#6&4044&3&700\\
\hline
\#7&3934&0&700\\
\hline
\#8&3692&0&800\\
\hline
\#9&5222&0&880\\
\hline
\#10&3548&0&800\\
\hline
\#11&4375&0&800\\
\hline
\#12&3671&0&800\\
\hline
\#13&4017&0&800\\
\hline
\#14&4530&0&700\\
\hline
\#15&4085&0&700\\
\hline
\#16&Out Of Time&Out Of Time&Out Of Time\\
\hline
\#17&3718&0&700\\
\hline
\#18&3126&0&800\\
\hline
\#19&4186&0&800\\
\hline
\#20&4000&1&700\\
\hline
\end{tabular}

\end{document}